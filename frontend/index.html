<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="app.css" />

	<title>Movie Night</title>
</head>
<body>
	<div>
		<input id="new_user_button" type="submit" value="Add New User">
	</div>
	<div>
		<ul id="user_list">			
		</ul>
	</div>
	<div>
		<form id="movie_input">
			<input name="movie title" type="text" id="movie_text" placeholder="Movie Title">
			<input type="submit" value="Enter">
		</form>
	</div>
	<div>
		<ul id="movie_list">
		</ul>
	</div>
</body>

<!-- <script type="text/javascript" src="single-device.js"></script> -->
<script type="text/javascript" src="MovieNightDB.js"></script>
<script type="text/javascript" src="Sortable.js"></script>
<script type="text/javascript">
	let movie_input = document.getElementById("movie_input");
	let movie_list = document.getElementById("movie_list");
	let movie_text = document.getElementById("movie_text");

	let user_list = document.getElementById("user_list");
	let newUserButton = document.getElementById("new_user_button");

	
	movie_input.addEventListener("submit", addMovieToList);
	newUserButton.addEventListener("click", addUserToList);
	user_list.addEventListener("click", changeActiveUser);


	const MDB = new MovieNightDB();

	let active_user = MDB.allUsers[0];

	refreshDBDisplay(active_user);


	new Sortable(movie_list, {
		animation:100,
		ghostClass: 'blue-background-class',
		onUpdate: update
	});

	function update(ev) {
		var items = Array.from(movie_list.children);

		for (var i = 0; i < items.length; i++) {
			movie_id = parseInt(items[i].id);
			score = i;
			MDB.setMovieScore( active_user_id, movie_id, score );
		}
		// tabulateRankings(db);
		// refreshDBDisplay();
	}

	function save(id, item) {
		window.localStorage.setItem(id, item);
	}

	function refreshDBDisplay(user) {
		movie_list.innerHTML = '';

		let scores = user.scores;
		for (id in scores) {
			let movie = MDB.getMovieById(id);
			item = document.createElement('li');
			item.textContent = movie.title;
			item.id = id;
			movie_list.appendChild(item);
		}

		user_list.innerHTML = '';
		let users = MDB.allUsers;

		for (uid in users) {
			const item = document.createElement('li');
			item.textContent = users[uid].name;
			item.id = uid;
	        user_list.appendChild(item);
		}; 
	}

	function addMovieToList(event) {
		event.preventDefault();
		var title = movie_text.value;
		if (title) {
			let id = MDB.addMovie(title)

			const movie = document.createElement('li');
			movie.textContent = title;
			movie.id = id;
	        movie_list.appendChild(movie);
	        movie_text.value = '';
		}
	}

	function addUserToList(event) {
		let new_username = prompt("Enter user name");
		if (new_username) {
			let id = MDB.addUser(new_username);
			const user = document.createElement('li');
			user.textContent = new_username;
			user_list.appendChild(user);
		}
	}

	function changeActiveUser(new_user_id) {

	}
	
</script>
</html>
